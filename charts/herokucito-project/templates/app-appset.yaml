---
apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: {{ .Values.project }}
  namespace: {{ .Values.project }}
spec:
  goTemplate: true
  goTemplateOptions: ["missingkey=error"]
  generators:
    - git:
        repoURL: "https://github.com/{{ .Values.repo.owner }}/{{ .Values.repo.name }}.git"
        revision: herokucito
        files:
          - path: "**/rendered_values.yaml"
        values:
          slug: '{{ `{{` }} .path.path | trimPrefix "" | slugify 23 {{ `}}` }}'
  template:
    metadata:
      name: "{{ .Values.project }}-{{ `{{` }} .values.slug {{ `}}` }}"
      annotations:
        kargo.akuity.io/authorized-stage: "{{ .Values.project }}:{{ `{{` }} .path.path {{ `}}` }}"
    spec:
      project: "{{ .Values.project }}"
      destination:
        server: https://kubernetes.default.svc
        namespace: "{{ .Values.project }}"
      sources:
        - repoURL: "https://github.com/{{ .Values.repo.owner }}/{{ .Values.repo.name }}.git"
          targetRevision: herokucito
          ref: values
        - repoURL: "{{ `{{` }} .helm.repoURL {{ `}}` }}"
          chart: "{{ `{{` }} .helm.chart {{ `}}` }}"
          path: "{{ `{{ dig "helm" "path" "" . }}` }}"
          targetRevision: "{{ `{{` }} .helm.targetRevision {{ `}}` }}"

          helm:
            valueFiles:
              - "$values/{{ `{{` }} .path.path {{ `}}` }}/rendered_values.yaml"

      syncPolicy:
        syncOptions:
          - ServerSideApply=true

  templatePatch: |
    {{ `{{-` }} if dig "helm" "autoSync" false . {{ `}}` }}
    spec:
      syncPolicy:
        automated:
          prune: {{ `{{` }} dig "helm" "prune" false . {{ `}}` }}
    {{ `{{-` }} end {{ `}}` }}
